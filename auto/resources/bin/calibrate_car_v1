#!/usr/bin/env python3

###############################################################################
#
# Copyright (c) 2017-2020 Master AI, Inc.
# ALL RIGHTS RESERVED
#
# Use of this library, in source or binary form, is prohibited without written
# approval from Master AI, Inc.
#
###############################################################################

import sys
import asyncio
import logging

from auto.services.console.client import CuiRoot
from auto.services.controller.client import CioRoot


START_PROMPT = """
**YOU ARE ABOUT TO CALIBRATE THIS CAR.**

If you do not have proper authority to
preform this calibration, **PLEASE EXIT
THIS SCRIPT**.

Press button 1 to BEGIN.
Press button 3 to EXIT.
"""


GYRO_ACCELL_PROMPT = """
Would you like to calibrate the
gyroscope and accelerometer?

Press button 1 for 'yes'.
Press button 3 for 'no'.
"""


GYRO_ACCELL_INSTRUCTIONS = """
During this calibration step, you must
place your car on a flat surface and
**DO NOT MOVE** it until this step
finishes.

Place your car on a flat surface, then
press button 1 to BEGIN.
"""


GYRO_ACCEL_STARTED = """
Started gyro & accel. calibration...

** DO NOT MOVE THE DEVICE UNTIL THIS
   STEP FINISHES. **
"""


CAR_MOTORS_PROMPT = """
Would you like to calibrate the car's
steering and drive-chain motors?

Press button 1 for 'yes'.
Press button 3 for 'no'.
"""


async def _clear(console):
    print("\x1b[2J\x1b[H")  # https://stackoverflow.com/a/2084560
    await console.clear_text()


async def _print_all(console, text, end='\n', **kwargs):
    print(text, end=end, **kwargs)
    await console.write_text(text + end)


async def _prompt(console, buttons, options, prompt_text):
    await _clear(console)
    await _print_all(console, prompt_text)
    while True:
        b = await buttons.wait_for_action()
        b = b[0] + 1
        if b in options:
            return b


async def _calibrate_car_motors(car, buzzer, buttons, leds):
    params = {
            'top':              40000,
            'steering_left':     3000,
            'steering_mid':      3000,
            'steering_right':    3000,
            'steering_millis':  30000,  # 30 seconds
            'throttle_forward':  4000,
            'throttle_mid':      3000,
            'throttle_reverse':  2000,
            'throttle_millis':  30000,  # 30 seconds
    }

    await car.on()

    await car.set_params(**params)

    _clear()
    print('Use button 1 and 3 to MOVE the steering.\nUse button 2 to SAVE the position.\n')
    print('Set the steering all the way **LEFT** and then save the position.\n')

    while True:
        await car.set_steering(45.0)
        b = await buttons.wait_for_action()
        b = b[0] + 1
        if b == 1:
            params['steering_left'] += 100
        elif b == 3:
            params['steering_left'] -= 100
        else:
            break
        await car.set_params(**params)

    await car.set_steering(0.0)

    _clear()
    print("DONE! Press any button to continue...")
    await buttons.wait_for_action()

    _clear()
    print('Use button 1 and 3 to MOVE the steering.\nUse button 2 to SAVE the position.\n')
    print('Set the steering all the way **RIGHT** and then save the position.\n')

    while True:
        await car.set_steering(-45.0)
        b = await buttons.wait_for_action()
        b = b[0] + 1
        if b == 1:
            params['steering_right'] += 100
        elif b == 3:
            params['steering_right'] -= 100
        else:
            break
        await car.set_params(**params)

    params['steering_mid'] = (params['steering_left'] + params['steering_right']) // 2
    await car.set_params(**params)

    await car.set_steering(0.0)

    _clear()
    print("DONE! Press any button to continue...")
    await buttons.wait_for_action()

    _clear()
    done = False
    while not done:
        print('Will check forward and reverse directions.\n')
        print('Car will drive **FORWARD** and then **REVERSE**.\n')
        print('** Please hold the car carefully in both hands,\n   with the wheels off the ground.')
        print('** Be sure the wheels can spin freely and safely\n   before proceeding.\n')
        print('Press button 2 when you are ready.')
        while True:
            b = await buttons.wait_for_action()
            b = b[0] + 1
            if b == 2:
                break
        await car.set_throttle(23)
        await asyncio.sleep(1)
        await car.set_throttle(-23)
        await asyncio.sleep(1)
        await car.set_throttle(0)
        print('\n\n\nDid the car move **FORWARD** then **REVERSE**?\n\nPress 1 for "yes", press 3 for "no".')
        while True:
            b = await buttons.wait_for_action()
            b = b[0] + 1
            if b == 1:
                done = True
                break
            elif b == 3:
                _clear()
                print('\n\n\nWill swap directions and try again...\n\n\n')
                await asyncio.sleep(1)
                params['throttle_forward'], params['throttle_reverse'] = params['throttle_reverse'], params['throttle_forward']
                await car.set_params(**params)
                break

    _clear()
    print("DONE! Press any button to continue...")
    await buttons.wait_for_action()

    _clear()
    left_dir = 1 if params['steering_mid'] < params['steering_left'] else -1
    left_dir *= 50  # <-- step size
    while True:
        await car.set_steering(0.0)
        print('Will check the steering direction for moving **STRAIGHT**.\n')
        print('Car will drive **FORWARD** and then **REVERSE**.\n')
        print('** Place car on the ground with an open area in front of it.')
        print('** Be sure the car can safely move forward for one second\n   without hitting anything.\n')
        print('Press button 2 when you are ready.')
        while True:
            b = await buttons.wait_for_action()
            b = b[0] + 1
            if b == 2:
                break
        await car.set_steering(0.0)
        await car.set_throttle(23)
        await asyncio.sleep(1)
        await car.set_throttle(-23)
        await asyncio.sleep(1)
        await car.set_throttle(0)
        print('\n\n\nDid the car drive roughly straight?\n\nPress 1 to correct a hair to the **LEFT**\nPress 3 to correct a hair to the **RIGHT**.\nPress 2 if it looked okay.')
        b = await buttons.wait_for_action()
        b = b[0] + 1
        if b == 1:
            params['steering_mid'] += left_dir
        elif b == 2:
            break
        elif b == 3:
            params['steering_mid'] -= left_dir
        await car.set_params(**params)

    _clear()
    print("DONE! Press any button to continue...")
    await buttons.wait_for_action()

    params['steering_millis'] = 1000
    params['throttle_millis'] = 1000
    await car.set_params(**params)
    await car.save_params()

    await car.off()


async def _calibrate_gyro_accel(console, calibrator, buttons, buzzer):
    _ = await _prompt(console, buttons, [1], GYRO_ACCELL_INSTRUCTIONS)

    # Wait for user to release the button and put the car down.
    await asyncio.sleep(2)

    # Start!
    await calibrator.start()
    await _print_all(console, GYRO_ACCEL_STARTED)

    while True:
        status = await calibrator.status()
        if status == -1:
            # Indicates we are done calibrating.
            break
        await _print_all(console, '.', end='', flush=True)
        await asyncio.sleep(1)

    await buzzer.play("G#4")


async def _calibrate(console, calibrator, buzzer, buttons, leds, car):
    answer = await _prompt(console, buttons, [1, 3], START_PROMPT)
    if answer == 3:
        return

    await buzzer.play("!T95 V9 O4")  # set tempo, volume, and octave

    answer = await _prompt(console, buttons, [1, 3], GYRO_ACCELL_PROMPT)
    if answer == 1:
        await _calibrate_gyro_accel(console, calibrator, buttons, buzzer)

    answer = await _prompt(console, buttons, [1, 3], CAR_MOTORS_PROMPT)
    if answer == 1:
        await _calibrate_car_motors(car, buzzer, buttons, leds)


async def run():
    console = CuiRoot()
    controller = CioRoot()

    await console.init()
    caps = await controller.init()

    required_caps = ['Calibrator', 'Buzzer', 'PushButtons', 'LEDs', 'CarMotors']
    has_all_required = all([rc in caps for rc in required_caps])

    v = await controller.acquire('VersionInfo')
    major, minor = await v.version()
    await controller.release(v)

    if major != 1 or not has_all_required:
        await _clear(console)
        await _print_all(console, 'This script is only used for AutoAuto v1 car controllers. Exiting...')
        await console.close()
        await controller.close()
        sys.exit(1)

    calibrator = await controller.acquire('Calibrator')
    buzzer = await controller.acquire('Buzzer')
    buttons = await controller.acquire('PushButtons')
    leds = await controller.acquire('LEDs')
    car = await controller.acquire('CarMotors')

    try:
        await _calibrate(console, calibrator, buzzer, buttons, leds, car)

    finally:
        await _clear(console)
        await _print_all(console, "Calibration script exiting...")

        await controller.release(calibrator)
        await controller.release(buzzer)
        await controller.release(buttons)
        await controller.release(leds)
        await controller.release(car)

        await console.close()
        await controller.close()


if __name__ == '__main__':
    logging.getLogger().setLevel(logging.WARNING)
    asyncio.run(run())

